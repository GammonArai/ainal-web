# 📱 Telegram認証システムガイド

## 🔐 概要

メールアドレス・パスワードの代わりにTelegramを使った認証システムです。
毎回新しいワンタイムパスワード（OTP）をTelegramに送信することで、パスワードを覚える必要がなく、セキュアな認証を実現します。

## 🌟 メリット

### ユーザー側
1. **パスワード不要** - 覚える必要なし
2. **セキュア** - 毎回異なるパスワード
3. **簡単** - Telegramで受信するだけ
4. **紛失リスクなし** - パスワードリセット不要

### 運営側
1. **本人確認** - Telegramアカウントで確実
2. **不正防止** - OTPで安全性向上
3. **管理簡素化** - パスワードリセット対応不要
4. **直接連絡可能** - 重要な通知も送信可能

## 📋 登録フロー

```
1. 紹介コード入力
     ↓
2. Telegramユーザー名入力
     ↓
3. 基本情報入力
     ↓
4. 登録完了
     ↓
5. Telegramに歓迎メッセージ
```

### 登録時のTelegramメッセージ例
```
🎉 愛なるマッサージへようこそ！

会員登録が完了しました。
会員番号：AM240112345

ログイン時は、このアカウントに
ワンタイムパスワードを送信します。

ご不明な点はお気軽にお問い合わせください。
```

## 🔑 ログインフロー

### 1. ユーザー名入力
```
Telegramユーザー名を入力
（@なしでもOK）
     ↓
「パスワードを送信」ボタン
```

### 2. OTP受信
```
Telegramにメッセージが届く：

🔐 ログインパスワード

あなたのワンタイムパスワード：
`123456`

⏱ 有効期限：5分間
🔒 他人に教えないでください
```

### 3. OTP入力
```
6桁のパスワードを入力
     ↓
ログイン完了
```

## 💻 技術仕様

### OTP仕様
- **形式**: 6桁の数字
- **有効期限**: 5分間
- **試行回数**: 3回まで
- **再送信**: 可能（前のOTPは無効化）

### セキュリティ
- OTPは一度しか使えない
- 有効期限後は自動削除
- 試行回数制限でブルートフォース対策
- HTTPSでの通信必須

### データ保存
```javascript
// ユーザーデータ
{
  telegramUsername: 'username',
  telegramChatId: '123456789', // Bot連携後に取得
  memberNumber: 'AM240112345',
  displayName: '山田太郎',
  phoneNumber: '090-1234-5678'
}

// OTPデータ（一時保存）
{
  otp: '123456',
  expires: Date.now() + 300000, // 5分
  attempts: 0
}
```

## 🤖 Telegram Bot設定

### 1. Bot作成
```
BotFatherで新規Bot作成
     ↓
トークン取得
     ↓
環境変数に設定
```

### 2. ユーザー連携
```javascript
// 初回メッセージでチャットID取得
bot.on('message', (ctx) => {
  const chatId = ctx.chat.id;
  const username = ctx.from.username;
  
  // DBに保存
  saveUserChatId(username, chatId);
});
```

### 3. OTP送信
```javascript
// OTP送信関数
async function sendOTP(username, otp) {
  const chatId = await getUserChatId(username);
  
  await bot.telegram.sendMessage(chatId, 
    `🔐 ログインパスワード\n\n` +
    `ワンタイムパスワード：\n` +
    `\`${otp}\`\n\n` +
    `⏱ 有効期限：5分間`,
    { parse_mode: 'Markdown' }
  );
}
```

## 🚀 実装ステップ

### Phase 1: 基本実装
- [x] Telegramユーザー名での登録
- [x] OTP送信・検証API
- [x] ログイン画面

### Phase 2: Bot連携
- [ ] Telegram Bot作成
- [ ] チャットID自動取得
- [ ] OTP自動送信

### Phase 3: 高度な機能
- [ ] 生体認証連携
- [ ] ログイン履歴
- [ ] 異常検知アラート

## 📱 ユーザー体験の最適化

### 良いUX
1. **明確な説明** - なぜTelegramが必要か
2. **シンプルな入力** - @マーク自動処理
3. **視覚的フィードバック** - OTP入力時のアニメーション
4. **エラーハンドリング** - 分かりやすいエラーメッセージ

### トラブルシューティング
- **OTPが届かない**
  - Botをブロックしていないか確認
  - ユーザー名が正しいか確認
  
- **ログインできない**
  - OTPの有効期限確認
  - 入力ミスがないか確認

## 🔒 セキュリティベストプラクティス

1. **Rate Limiting** - 連続リクエスト制限
2. **IP制限** - 不審なIPからのアクセスブロック
3. **ログ記録** - 全ての認証試行を記録
4. **アラート** - 異常なアクセスパターン検知

## 💡 運用のヒント

### 初期導入時
- 既存会員への説明資料作成
- サポート体制の準備
- FAQ作成

### 継続運用
- ログイン成功率の監視
- OTP送信遅延の監視
- ユーザーフィードバック収集

## 📈 期待される効果

1. **セキュリティ向上** - 不正アクセス激減
2. **ユーザー満足度** - パスワード忘れストレスなし
3. **運用コスト削減** - パスワードリセット対応不要
4. **エンゲージメント向上** - Telegram経由の通知活用