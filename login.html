<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šå“¡ãƒ­ã‚°ã‚¤ãƒ³ | æ„›ãªã‚‹ãƒãƒƒã‚µãƒ¼ã‚¸</title>
    <meta name="description" content="æ„›ãªã‚‹ãƒãƒƒã‚µãƒ¼ã‚¸ã®ä¼šå“¡ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã€‚Telegramèªè¨¼ã«ã‚ˆã‚‹ãƒ­ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã€‚">
    
    <!-- ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/images/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/images/android-chrome-512x512.png">
    
    <link rel="stylesheet" href="modern-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            padding: var(--space-6);
            position: relative;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><circle cx="200" cy="200" r="100" fill="rgba(255,255,255,0.05)"/><circle cx="800" cy="300" r="150" fill="rgba(255,255,255,0.03)"/><circle cx="300" cy="800" r="120" fill="rgba(255,255,255,0.04)"/></svg>');
        }

        .login-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-12);
            box-shadow: var(--shadow-2xl);
            width: 100%;
            max-width: 450px;
            position: relative;
            z-index: 2;
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--space-10);
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-6);
            box-shadow: var(--shadow-lg);
        }

        .login-logo i {
            font-size: 2rem;
            color: white;
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-3);
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .login-form {
            display: grid;
            gap: var(--space-6);
        }

        .form-group {
            display: grid;
            gap: var(--space-2);
        }

        .form-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-input {
            padding: var(--space-4);
            border: 2px solid var(--border-gray);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .phone-input-group {
            display: flex;
            gap: var(--space-3);
            align-items: end;
        }

        .phone-input {
            flex: 1;
        }

        .sms-send-btn {
            flex-shrink: 0;
            padding: var(--space-4) var(--space-6);
            background: var(--gradient-accent);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .sms-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .sms-send-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        .verification-step {
            display: none;
            background: var(--light-gray);
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--accent-cyan);
        }

        .verification-step.active {
            display: block;
        }

        .verification-info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .verification-info i {
            color: var(--accent-cyan);
        }

        .code-input {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.5em;
        }

        .login-btn {
            padding: var(--space-4);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .login-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            color: var(--admin-danger);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            border-left: 4px solid var(--admin-danger);
            display: none;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            color: var(--admin-success);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            border-left: 4px solid var(--admin-success);
            display: none;
        }

        .login-footer {
            text-align: center;
            margin-top: var(--space-8);
            padding-top: var(--space-6);
            border-top: 1px solid var(--border-gray);
        }

        .login-footer a {
            color: var(--accent-purple);
            text-decoration: none;
            font-weight: 600;
        }

        .login-footer a:hover {
            text-decoration: underline;
        }

        .back-to-home {
            position: absolute;
            top: var(--space-6);
            left: var(--space-6);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            transition: all 0.3s ease;
            z-index: 3;
        }

        .back-to-home:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-4px);
        }

        @media (max-width: 768px) {
            .login-card {
                padding: var(--space-8);
                margin: var(--space-4);
            }

            .phone-input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .sms-send-btn {
                padding: var(--space-4);
            }
        }
    </style>
</head>
<body class="modern-massage">
    <div class="login-container">
        <a href="index.html" class="back-to-home">
            <i class="fas fa-arrow-left"></i>
            ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
        </a>

        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-spa"></i>
                </div>
                <h1 class="login-title">ä¼šå“¡ãƒ­ã‚°ã‚¤ãƒ³ãƒ»æ–°è¦ç™»éŒ²</h1>
                <p class="login-subtitle">Telegram Botã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãƒ»ãƒ­ã‚°ã‚¤ãƒ³</p>
            </div>

            <form class="login-form" id="login-form">
                <div class="error-message" id="error-message"></div>
                <div class="success-message" id="success-message"></div>

                <!-- Telegramèªè¨¼ã‚¹ãƒ†ãƒƒãƒ— -->
                <div id="telegram-step">
                    <div class="form-group">
                        <label class="form-label" for="telegram-id">Telegramãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                        <div class="phone-input-group">
                            <input 
                                type="text" 
                                id="telegram-id" 
                                class="form-input phone-input" 
                                placeholder="@username ã¾ãŸã¯æ•°å­—ID"
                                required
                            >
                            <button type="button" class="sms-send-btn" id="telegram-send-btn">
                                ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²
                            </button>
                        </div>
                        <small style="color: var(--text-muted); font-size: 0.85rem;">
                            åˆå›åˆ©ç”¨æ™‚ã¯è‡ªå‹•ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¾ã™
                        </small>
                    </div>
                    <div class="telegram-info" style="background: rgba(42, 171, 238, 0.1); padding: var(--space-4); border-radius: var(--radius-lg); margin-top: var(--space-4); border-left: 4px solid #2AABEE;">
                        <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
                            <i class="fab fa-telegram" style="color: #2AABEE; font-size: 1.2rem;"></i>
                            <strong style="color: var(--text-primary);">Telegram Botã®ä½¿ã„æ–¹</strong>
                        </div>
                        <ol style="margin: 0; padding-left: var(--space-5); color: var(--text-secondary); font-size: 0.9rem;">
                            <li>Telegramã§ <strong><a href="http://t.me/AnalSenseiBot" target="_blank" style="color: #2AABEE; text-decoration: none;">@AnalSenseiBot</a></strong> ã‚’æ¤œç´¢ã¾ãŸã¯ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                            <li>Botã‚’é–‹å§‹ã—ã€<strong>/start</strong> ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã—ã¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²</li>
                            <li>Botã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç¢ºèªã—ã€ä¸Šè¨˜ã«å…¥åŠ›</li>
                            <li>ã€Œãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å—ä¿¡</li>
                        </ol>
                    </div>
                </div>

                <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²ã‚¹ãƒ†ãƒƒãƒ— -->
                <div class="verification-step" id="profile-step" style="display: none;">
                    <div class="verification-info">
                        <i class="fas fa-user-edit" style="color: var(--accent-purple);"></i>
                        æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã®ãŸã‚ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                    </div>
                    <div style="display: grid; gap: var(--space-4);">
                        <div class="form-group">
                            <label class="form-label" for="customer-name">ãŠåå‰ï¼ˆãƒ•ãƒ«ãƒãƒ¼ãƒ ï¼‰<span style="color: red;">*</span></label>
                            <input 
                                type="text" 
                                id="customer-name" 
                                class="form-input" 
                                placeholder="å±±ç”° å¤ªéƒ"
                                required
                            >
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="customer-birthday">ç”Ÿå¹´æœˆæ—¥<span style="color: red;">*</span></label>
                            <input 
                                type="date" 
                                id="customer-birthday" 
                                class="form-input" 
                                required
                            >
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="customer-gender">æ€§åˆ¥</label>
                            <select id="customer-gender" class="form-input">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="ç”·æ€§">ç”·æ€§</option>
                                <option value="å¥³æ€§">å¥³æ€§</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="customer-notes">ã”è¦æœ›ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç­‰</label>
                            <textarea 
                                id="customer-notes" 
                                class="form-input" 
                                rows="3"
                                placeholder="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã€ã”è¦æœ›ã€ãã®ä»–ãŠèã‹ã›ãã ã•ã„"
                            ></textarea>
                        </div>
                    </div>
                    <button type="button" class="sms-send-btn" id="profile-submit-btn" style="width: 100%; margin-top: var(--space-4);">
                        <i class="fas fa-user-check"></i>
                        ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²å®Œäº†
                    </button>
                </div>

                <!-- Telegramèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒƒãƒ— -->
                <div class="verification-step" id="verification-step">
                    <div class="verification-info">
                        <i class="fab fa-telegram" style="color: #2AABEE;"></i>
                        <span id="sent-telegram"></span>ã«ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="verification-code">ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ¡ï¼‰</label>
                        <input 
                            type="text" 
                            id="verification-code" 
                            class="form-input code-input" 
                            placeholder="123456"
                            maxlength="6"
                            pattern="[0-9]{6}"
                        >
                        <small style="color: var(--text-muted); font-size: 0.85rem;">
                            5åˆ†é–“æœ‰åŠ¹ã§ã™ã€‚å±Šã‹ãªã„å ´åˆã¯å†é€ä¿¡ã—ã¦ãã ã•ã„
                        </small>
                    </div>
                    <button type="button" class="sms-send-btn" id="resend-btn" style="width: 100%; margin-top: var(--space-3);">
                        <i class="fab fa-telegram"></i>
                        ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†é€ä¿¡
                    </button>
                </div>

                <button type="submit" class="login-btn" id="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </form>

            <div class="login-footer">
                <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">
                    Telegram Botã§ã‹ã‚“ãŸã‚“ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³<br>
                    ãŠå›°ã‚Šã®éš›ã¯: <a href="https://t.me/AnalSenseiBot" target="_blank">Telegram Bot</a>
                </p>
                <p style="margin: var(--space-4) 0 0; color: var(--text-muted); font-size: 0.85rem;">
                    <i class="fab fa-telegram" style="color: #2AABEE;"></i>
                    Telegram: <strong><a href="http://t.me/AnalSenseiBot" target="_blank" style="color: #2AABEE; text-decoration: none;">@AnalSenseiBot</a></strong>
                </p>
            </div>
        </div>
    </div>

    <script>
        // ä¼šå“¡ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç®¡ç†ï¼‰
        let memberDatabase = {
            '@shotaimai': { 
                name: 'ä»Šäº•ç¿”å¤ª', 
                telegramId: '@shotaimai', 
                visits: 10, 
                registeredAt: '2024-01-01',
                lastLogin: '2024-06-15',
                status: 'vip',
                birthday: '1990-01-01',
                gender: 'ç”·æ€§',
                notes: 'ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ'
            },
            '@tanaka_taro': { 
                name: 'ç”°ä¸­å¤ªéƒ', 
                telegramId: '@tanaka_taro', 
                visits: 5, 
                registeredAt: '2024-05-01',
                lastLogin: '2024-06-10',
                status: 'active'
            },
            '@sato_hanako': { 
                name: 'ä½è—¤èŠ±å­', 
                telegramId: '@sato_hanako', 
                visits: 3, 
                registeredAt: '2024-05-15',
                lastLogin: '2024-06-08',
                status: 'active'
            },
            '@yamada_ichiro': { 
                name: 'å±±ç”°ä¸€éƒ', 
                telegramId: '@yamada_ichiro', 
                visits: 8, 
                registeredAt: '2024-04-20',
                lastLogin: '2024-06-12',
                status: 'vip'
            },
            '123456789': { 
                name: 'éˆ´æœ¨æ¬¡éƒ', 
                telegramId: '123456789', 
                visits: 2, 
                registeredAt: '2024-06-01',
                lastLogin: '2024-06-05',
                status: 'active'
            },
            '@test_user': { 
                name: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼', 
                telegramId: '@test_user', 
                visits: 1, 
                registeredAt: '2024-06-14',
                lastLogin: '2024-06-14',
                status: 'active'
            }
        };

        // ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä¿å­˜ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã¾ãŸã¯Redisç­‰ã§ç®¡ç†ï¼‰
        let otpDatabase = {};

        let currentTelegramId = '';
        let verificationCode = '';
        let isVerificationSent = false;

        // DOMè¦ç´ 
        const telegramInput = document.getElementById('telegram-id');
        const telegramSendBtn = document.getElementById('telegram-send-btn');
        const verificationStep = document.getElementById('verification-step');
        const verificationCodeInput = document.getElementById('verification-code');
        const loginBtn = document.getElementById('login-btn');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const sentTelegramSpan = document.getElementById('sent-telegram');
        const resendBtn = document.getElementById('resend-btn');
        const profileSubmitBtn = document.getElementById('profile-submit-btn');

        // TelegramIDãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatTelegramId(telegramId) {
            telegramId = telegramId.trim();
            if (telegramId.startsWith('@')) {
                return telegramId.toLowerCase();
            }
            // æ•°å­—ã®ã¿ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
            if (/^\d+$/.test(telegramId)) {
                return telegramId;
            }
            // @ãŒãªã„å ´åˆã¯è¿½åŠ 
            return '@' + telegramId.toLowerCase();
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ»æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éè¡¨ç¤º
        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // Telegram Bot APIè¨­å®š
        const TELEGRAM_BOT_TOKEN = '8112391212:AAFL1KvxMv6C8kqVCtFCumWIfR3MxBjGhYM';
        const TELEGRAM_API_URL = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}`;

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä¸€æ™‚ä¿å­˜
        let tempProfileData = {};
        let isNewAccountCreation = false;

        // æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ©Ÿèƒ½
        function createNewAccount(telegramId, profileData) {
            const now = new Date();
            const birthday = new Date(profileData.birthday);
            const age = new Date().getFullYear() - birthday.getFullYear();
            
            const newAccount = {
                name: profileData.name,
                telegramId: telegramId,
                phone: profileData.phone,
                birthday: profileData.birthday,
                age: age,
                gender: profileData.gender || 'æœªè¨­å®š',
                notes: profileData.notes || '',
                visits: 0,
                registeredAt: now.toISOString().split('T')[0],
                lastLogin: now.toISOString().split('T')[0],
                status: 'active',
                totalSpent: 0,
                allergies: profileData.notes || '',
                preferredTherapist: '',
                communicationMethod: 'telegram'
            };
            
            memberDatabase[telegramId] = newAccount;
            console.log(`æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ: ${telegramId}`, newAccount);
            return newAccount;
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®æ¤œè¨¼
        function validateProfileData() {
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const birthday = document.getElementById('customer-birthday').value;
            
            if (!name) {
                showError('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return false;
            }
            
            if (!phone) {
                showError('é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return false;
            }
            
            // é›»è©±ç•ªå·ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
            const phoneRegex = /^0\d{1,4}-?\d{1,4}-?\d{4}$/;
            if (!phoneRegex.test(phone.replace(/-/g, ''))) {
                showError('æ­£ã—ã„é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š090-1234-5678ï¼‰');
                return false;
            }
            
            if (!birthday) {
                showError('ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return false;
            }
            
            // å¹´é½¢ãƒã‚§ãƒƒã‚¯ï¼ˆ18æ­³ä»¥ä¸Šï¼‰
            const birthDate = new Date(birthday);
            const age = new Date().getFullYear() - birthDate.getFullYear();
            if (age < 18) {
                showError('18æ­³ä»¥ä¸Šã®æ–¹ã®ã¿ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™');
                return false;
            }
            
            return true;
        }

        // ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆãƒ»ä¿å­˜æ©Ÿèƒ½
        function generateOTP(telegramId) {
            const otp = Math.floor(100000 + Math.random() * 900000).toString();
            const expiryTime = Date.now() + (5 * 60 * 1000); // 5åˆ†å¾Œ
            
            otpDatabase[telegramId] = {
                code: otp,
                expiryTime: expiryTime,
                attempts: 0
            };
            
            return otp;
        }

        // OTPæ¤œè¨¼æ©Ÿèƒ½
        function verifyOTP(telegramId, inputCode) {
            const otpData = otpDatabase[telegramId];
            
            if (!otpData) {
                return { success: false, message: 'ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' };
            }
            
            if (Date.now() > otpData.expiryTime) {
                delete otpDatabase[telegramId];
                return { success: false, message: 'ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™' };
            }
            
            otpData.attempts++;
            
            if (otpData.attempts > 3) {
                delete otpDatabase[telegramId];
                return { success: false, message: 'è©¦è¡Œå›æ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚å†åº¦ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦ãã ã•ã„' };
            }
            
            if (otpData.code !== inputCode) {
                return { success: false, message: 'ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' };
            }
            
            // æˆåŠŸæ™‚ã¯OTPã‚’å‰Šé™¤
            delete otpDatabase[telegramId];
            return { success: true, message: 'èªè¨¼æˆåŠŸ' };
        }

        // Telegram Boté€ä¿¡æ©Ÿèƒ½
        async function sendTelegramMessage(telegramId, isNewAccount = false) {
            const otp = generateOTP(telegramId);
            
            let message;
            if (isNewAccount) {
                message = `ã€æ„›ãªã‚‹ãƒãƒƒã‚µãƒ¼ã‚¸ã€‘æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå®Œäº†ï¼\n\nãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${otp}\n\nâœ¨ ã”ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™\nğŸ• æœ‰åŠ¹æœŸé™: 5åˆ†é–“\n\nã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚`;
            } else {
                const member = memberDatabase[telegramId];
                message = `ã€æ„›ãªã‚‹ãƒãƒƒã‚µãƒ¼ã‚¸ã€‘ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼\n\nãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${otp}\n\nğŸ‘‹ ${member.name}æ§˜ã€ãŠç–²ã‚Œæ§˜ã§ã™\nğŸ• æœ‰åŠ¹æœŸé™: 5åˆ†é–“\n\nã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚`;
            }

            try {
                console.log(`Telegram Boté€ä¿¡: ${telegramId} ã«ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ ${otp} ã‚’é€ä¿¡`);
                console.log(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹: "${message}"`);
                console.log(`å®Ÿéš›ã®é€ä¿¡ã¯ä»¥ä¸‹ã®APIã‚’ä½¿ç”¨: ${TELEGRAM_API_URL}/sendMessage`);
                
                // æœ¬ç•ªç’°å¢ƒã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«APIã‚’å‘¼ã³å‡ºã—
                /*
                const response = await fetch(`${TELEGRAM_API_URL}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: telegramId,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Telegramé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                */
                
                return Promise.resolve(true);
            } catch (error) {
                console.error('Telegramé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                return Promise.reject(error);
            }
        }

        // Telegramèªè¨¼é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
        telegramSendBtn.addEventListener('click', async function() {
            hideMessages();
            
            const telegramId = formatTelegramId(telegramInput.value);
            
            if (!telegramId) {
                showError('TelegramIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            currentTelegramId = telegramId;
            telegramSendBtn.disabled = true;
            telegramSendBtn.innerHTML = '<div class="loading-spinner"></div> å‡¦ç†ä¸­...';

            try {
                // @shotaimaiã®å ´åˆã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã§ãƒ­ã‚°ã‚¤ãƒ³
                if (telegramId === '@shotaimai') {
                    const memberInfo = memberDatabase[telegramId];
                    
                    // æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»ã‚’æ›´æ–°
                    memberInfo.lastLogin = new Date().toISOString().split('T')[0];
                    
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜
                    localStorage.setItem('memberLogin', JSON.stringify({
                        telegramId: telegramId,
                        name: memberInfo.name,
                        visits: memberInfo.visits,
                        status: memberInfo.status,
                        loginTime: new Date().toISOString()
                    }));

                    showSuccess('ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚æ–½è¡“å†…å®¹ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã™...');
                    
                    console.log(`ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${memberInfo.name} (${telegramId})`);
                    
                    setTimeout(() => {
                        window.location.href = 'services.html';
                    }, 1500);
                    
                    return;
                }
                
                // æ—¢å­˜ä¼šå“¡ã‹ãƒã‚§ãƒƒã‚¯
                if (!memberDatabase[telegramId]) {
                    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²ç”»é¢ã‚’è¡¨ç¤º
                    isNewAccountCreation = true;
                    document.getElementById('profile-step').style.display = 'block';
                    telegramSendBtn.innerHTML = 'ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²';
                    telegramSendBtn.disabled = false;
                    showSuccess('æ–°è¦ç™»éŒ²ã§ã™ã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    document.getElementById('customer-name').focus();
                } else {
                    // æ—¢å­˜ä¼šå“¡ã®å ´åˆã€ç›´æ¥OTPé€ä¿¡
                    await sendTelegramMessage(telegramId, false);
                    
                    // èªè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
                    verificationStep.classList.add('active');
                    sentTelegramSpan.textContent = telegramInput.value;
                    showSuccess('Telegramã«ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
                    isVerificationSent = true;
                    
                    // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æˆ»ã™
                    telegramSendBtn.innerHTML = 'ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²';
                    telegramSendBtn.disabled = false;
                    
                    // èªè¨¼ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                    verificationCodeInput.focus();
                }
                
            } catch (error) {
                showError('å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                telegramSendBtn.innerHTML = 'ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²';
                telegramSendBtn.disabled = false;
            }
        });

        // Telegramèªè¨¼ã‚³ãƒ¼ãƒ‰å†é€ä¿¡
        resendBtn.addEventListener('click', async function() {
            hideMessages();
            resendBtn.disabled = true;
            resendBtn.innerHTML = '<div class="loading-spinner"></div> å†é€ä¿¡ä¸­...';

            try {
                const isExistingMember = memberDatabase[currentTelegramId];
                await sendTelegramMessage(currentTelegramId, !isExistingMember);
                showSuccess('ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†é€ä¿¡ã—ã¾ã—ãŸ');
                resendBtn.innerHTML = '<i class="fab fa-telegram"></i> ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†é€ä¿¡';
                resendBtn.disabled = false;
            } catch (error) {
                showError('å†é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                resendBtn.innerHTML = '<i class="fab fa-telegram"></i> ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†é€ä¿¡';
                resendBtn.disabled = false;
            }
        });

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²å®Œäº†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
        profileSubmitBtn.addEventListener('click', async function() {
            hideMessages();
            
            if (!validateProfileData()) {
                return;
            }
            
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—
            tempProfileData = {
                name: document.getElementById('customer-name').value.trim(),
                phone: document.getElementById('customer-phone').value.trim(),
                birthday: document.getElementById('customer-birthday').value,
                gender: document.getElementById('customer-gender').value,
                notes: document.getElementById('customer-notes').value.trim()
            };
            
            profileSubmitBtn.disabled = true;
            profileSubmitBtn.innerHTML = '<div class="loading-spinner"></div> ç™»éŒ²ä¸­...';
            
            try {
                // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
                createNewAccount(currentTelegramId, tempProfileData);
                
                // OTPã‚’é€ä¿¡
                await sendTelegramMessage(currentTelegramId, true);
                
                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¥åŠ›ç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã¦èªè¨¼ç”»é¢ã‚’è¡¨ç¤º
                document.getElementById('profile-step').style.display = 'none';
                verificationStep.classList.add('active');
                sentTelegramSpan.textContent = telegramInput.value;
                
                showSuccess('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²å®Œäº†ï¼Telegramã«ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
                isVerificationSent = true;
                
                profileSubmitBtn.innerHTML = '<i class="fas fa-user-check"></i> ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²å®Œäº†';
                profileSubmitBtn.disabled = false;
                
                // èªè¨¼ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                verificationCodeInput.focus();
                
            } catch (error) {
                showError('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                profileSubmitBtn.innerHTML = '<i class="fas fa-user-check"></i> ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç™»éŒ²å®Œäº†';
                profileSubmitBtn.disabled = false;
            }
        });

        // èªè¨¼ã‚³ãƒ¼ãƒ‰å…¥åŠ›æ™‚ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        verificationCodeInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^\d]/g, '');
        });

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            hideMessages();

            if (!isVerificationSent) {
                showError('ã¾ãšTelegramèªè¨¼ã‚’è¡Œã£ã¦ãã ã•ã„');
                return;
            }

            const inputCode = verificationCodeInput.value;
            
            if (!inputCode || inputCode.length !== 6) {
                showError('6æ¡ã®ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // OTPæ¤œè¨¼
            const verificationResult = verifyOTP(currentTelegramId, inputCode);
            
            if (!verificationResult.success) {
                showError(verificationResult.message);
                return;
            }

            // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<div class="loading-spinner"></div> ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';

            setTimeout(() => {
                const memberInfo = memberDatabase[currentTelegramId];
                
                // æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»ã‚’æ›´æ–°
                memberInfo.lastLogin = new Date().toISOString().split('T')[0];
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜
                localStorage.setItem('memberLogin', JSON.stringify({
                    telegramId: currentTelegramId,
                    name: memberInfo.name,
                    visits: memberInfo.visits,
                    status: memberInfo.status,
                    loginTime: new Date().toISOString()
                }));

                showSuccess('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚æ–½è¡“å†…å®¹ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã™...');
                
                console.log(`ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${memberInfo.name} (${currentTelegramId})`);
                
                setTimeout(() => {
                    window.location.href = 'services.html';
                }, 1500);
            }, 1000);
        });

        // TelegramIDå…¥åŠ›æ™‚ã®å‡¦ç†
        telegramInput.addEventListener('input', function() {
            hideMessages();
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        window.addEventListener('load', function() {
            const memberLogin = localStorage.getItem('memberLogin');
            if (memberLogin) {
                const loginData = JSON.parse(memberLogin);
                const loginTime = new Date(loginData.loginTime);
                const now = new Date();
                const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                
                // 24æ™‚é–“ä»¥å†…ãªã‚‰è‡ªå‹•ã§ã‚µãƒ¼ãƒ“ã‚¹ãƒšãƒ¼ã‚¸ã¸
                if (hoursDiff < 24) {
                    window.location.href = 'services.html';
                }
            }
        });
    </script>
</body>
</html>